<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STM32 PWM 代码生成器 | 终极修复版</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #334155;
            --primary: #3b82f6;
            --primary-hover: #2563eb;
            --accent: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border: #475569;
            --radius: 12px;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            background: var(--bg-body);
            background-image: radial-gradient(at 0% 0%, rgba(59, 130, 246, 0.1) 0px, transparent 50%), 
                              radial-gradient(at 100% 100%, rgba(16, 185, 129, 0.1) 0px, transparent 50%);
            color: var(--text-main);
            font-family: 'Inter', system-ui, sans-serif;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .container { width: 100%; max-width: 1400px; }
        
        /* 顶部导航 */
        header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 20px 0 30px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 30px;
        }
        .brand { display: flex; align-items: center; gap: 15px; }
        .brand i { font-size: 2rem; color: var(--primary); }
        .brand h1 { font-size: 1.6rem; font-weight: 700; letter-spacing: -0.5px; }
        .tag { background: var(--accent); color: white; font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; vertical-align: middle; margin-left: 10px; }
        .github-btn { color: var(--text-muted); text-decoration: none; transition: 0.2s; font-size: 1.5rem; }
        .github-btn:hover { color: white; transform: scale(1.1); }

        /* 主布局 */
        .grid { display: grid; grid-template-columns: 360px 1fr; gap: 30px; }
        @media (max-width: 1024px) { .grid { grid-template-columns: 1fr; } }

        /* 卡片通用样式 */
        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 25px; box-shadow: var(--shadow); }
        .card-header { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; font-weight: 600; color: var(--primary); font-size: 1.1rem; }

        /* 表单控件 */
        .control-group { margin-bottom: 20px; }
        label { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; color: var(--text-muted); font-weight: 500; }
        
        select, input[type="number"], input[type="text"] {
            width: 100%; background: var(--bg-input); border: 1px solid var(--border);
            color: white; padding: 12px; border-radius: 8px;
            font-family: 'JetBrains Mono', monospace; font-size: 0.95rem; outline: none; transition: 0.2s;
        }
        select:focus, input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }

        /* 滑块样式 */
        input[type=range] {
            width: 100%; -webkit-appearance: none; background: transparent; margin-top: 10px;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 6px; background: var(--bg-input); border-radius: 3px;
        }
        input[type=range]::-webkit-slider-thumb {
            height: 18px; width: 18px; border-radius: 50%; background: var(--primary);
            cursor: pointer; -webkit-appearance: none; margin-top: -6px; box-shadow: 0 0 10px rgba(59,130,246,0.5);
        }

        /* 徽章 */
        .badge { font-size: 0.75rem; padding: 3px 8px; border-radius: 4px; font-weight: 600; }
        .badge-remap { background: rgba(245, 158, 11, 0.15); color: var(--warning); border: 1px solid rgba(245, 158, 11, 0.3); }
        .badge-def { background: rgba(148, 163, 184, 0.15); color: var(--text-muted); border: 1px solid var(--border); }

        /* 仪表盘统计 */
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin-top: 20px; }
        .stat-item { text-align: center; }
        .stat-label { font-size: 0.75rem; color: var(--text-muted); display: block; margin-bottom: 4px; }
        .stat-value { font-family: 'JetBrains Mono'; font-weight: 700; color: var(--accent); font-size: 1.1rem; }
        .stat-value.error { color: var(--danger); }

        /* 高级设置折叠面板 */
        .advanced-toggle {
            width: 100%; background: transparent; border: 1px dashed var(--border); color: var(--text-muted);
            padding: 10px; border-radius: 8px; cursor: pointer; margin-top: 20px; font-size: 0.9rem; transition: 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .advanced-toggle:hover { border-color: var(--primary); color: var(--primary); }
        .advanced-panel { display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.05); animation: slideDown 0.3s ease; }

        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* 代码区域 */
        .code-container { height: 100%; display: flex; flex-direction: column; background: #0d1117; border-radius: var(--radius); border: 1px solid var(--border); overflow: hidden; }
        
        .code-tabs { display: flex; background: rgba(0,0,0,0.3); border-bottom: 1px solid var(--border); }
        .tab { padding: 12px 25px; cursor: pointer; font-size: 0.9rem; color: var(--text-muted); border-right: 1px solid var(--border); transition: 0.2s; user-select: none; }
        .tab:hover { background: rgba(255,255,255,0.05); }
        .tab.active { background: #0d1117; color: var(--primary); font-weight: 600; border-top: 2px solid var(--primary); }

        .code-toolbar { padding: 10px; display: flex; justify-content: flex-end; gap: 10px; background: #0d1117; }
        .btn { padding: 8px 16px; border-radius: 6px; border: none; font-size: 0.85rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: 0.2s; }
        .btn-copy { background: var(--bg-input); color: white; border: 1px solid var(--border); }
        .btn-copy:hover { border-color: var(--text-muted); }
        .btn-download { background: var(--primary); color: white; }
        .btn-download:hover { background: var(--primary-hover); }

        pre { flex: 1; padding: 20px; margin: 0; overflow: auto; font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; line-height: 1.6; color: #e6edf3; }
        
        /* 语法高亮模拟 */
        .c-kw { color: #ff7b72; } /* 关键字 */
        .c-fn { color: #d2a8ff; } /* 函数 */
        .c-ty { color: #79c0ff; } /* 类型 */
        .c-nm { color: #79c0ff; } /* 数字 */
        .c-cm { color: #8b949e; font-style: italic; } /* 注释 */
        .c-df { color: #d2a8ff; } /* 定义 */

        /* 提示框 */
        .toast {
            position: fixed; bottom: 30px; right: 30px; background: var(--bg-card); border: 1px solid var(--accent);
            padding: 15px 25px; border-radius: 8px; display: flex; align-items: center; gap: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); transform: translateY(100px); opacity: 0; transition: 0.3s; pointer-events: none;
        }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast i { color: var(--accent); }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="brand">
                <i class="fas fa-microchip"></i>
                <div>
                    <h1>STM32 PWM 代码生成器 by Gemini<span class="tag">Fix</span></h1>
                </div>
            </div>
            <a href="https://github.com/yukino387/STM32-PWM-Generator?tab=readme-ov-file" target="_blank" class="github-btn" title="跳转到 GitHub 仓库"><i class="fab fa-github"></i></a>
        </header>

        <div class="grid">
            <div class="card">
                <div class="card-header"><i class="fas fa-cogs"></i> 参数配置</div>
                
                <div class="control-group">
                    <label>定时器 (Timer)</label>
                    <select id="timer">
                        <option value="TIM1">TIM1 (高级定时器, APB2)</option>
                        <option value="TIM2">TIM2 (通用定时器, APB1)</option>
                        <option value="TIM3" selected>TIM3 (通用定时器, APB1)</option>
                        <option value="TIM4">TIM4 (通用定时器, APB1)</option>
                        <option value="TIM8">TIM8 (高级定时器, APB2)</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>
                        <span>输出引脚 (Pin)</span>
                        <span id="pin-badge" class="badge badge-def">默认</span>
                    </label>
                    <select id="pin"></select>
                    <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 8px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-link"></i> 自动映射通道: <strong id="channel-disp" style="color: var(--primary)">--</strong>
                    </div>
                </div>

                <div class="control-group">
                    <label>
                        <span>PWM 频率 (Hz)</span>
                        <span id="freq-disp" style="color: var(--accent)">1000 Hz</span>
                    </label>
                    <input type="number" id="freq" value="1000" min="1" max="1000000">
                    <input type="range" id="freq-range" min="1" max="20000" value="1000">
                </div>

                <div class="control-group">
                    <label>
                        <span>占空比 (%)</span>
                        <span id="duty-disp" style="color: var(--accent)">50%</span>
                    </label>
                    <input type="number" id="duty" value="50" min="0" max="100">
                    <input type="range" id="duty-range" min="0" max="100" value="50">
                </div>

                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-label">ARR (自动重装)</span>
                        <span class="stat-value" id="res-arr">--</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">PSC (预分频)</span>
                        <span class="stat-value" id="res-psc">--</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">实际频率</span>
                        <span class="stat-value" id="res-freq">--</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">误差</span>
                        <span class="stat-value" id="res-err">0%</span>
                    </div>
                </div>

                <button class="advanced-toggle" id="toggle-adv">
                    <i class="fas fa-sliders-h"></i> 高级设置 (时钟/极性/函数名)
                </button>
                <div class="advanced-panel" id="adv-panel">
                    <div class="control-group">
                        <label>系统时钟 (SystemCoreClock)</label>
                        <div style="position: relative;">
                            <input type="number" id="sys-clock" value="72000000">
                            <span style="position: absolute; right: 10px; top: 12px; font-size: 0.8rem; color: var(--text-muted);">Hz</span>
                        </div>
                    </div>
                    <div class="control-group">
                        <label>输出极性 (Polarity)</label>
                        <select id="polarity">
                            <option value="High">High (高电平有效)</option>
                            <option value="Low">Low (低电平有效)</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>函数名称前缀 (文件名将自动转为小写)</label>
                        <input type="text" id="func-name" value="Motor_PWM" placeholder="例如: Motor_PWM">
                    </div>
                </div>
            </div>

            <div class="code-container">
                <div class="code-tabs">
                    <div class="tab active" onclick="switchTab('c')" id="tab-c">motor_pwm.c</div>
                    <div class="tab" onclick="switchTab('h')" id="tab-h">motor_pwm.h</div>
                </div>
                <div class="code-toolbar">
                    <button class="btn btn-copy" onclick="copyCode()"><i class="far fa-copy"></i> 复制</button>
                    <button class="btn btn-download" onclick="downloadFiles()"><i class="fas fa-download"></i> 下载工程文件</button>
                </div>
                <pre id="code-inner"></pre>
            </div>
        </div>
    </div>

    <div class="toast" id="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toast-msg">代码已复制到剪贴板</span>
    </div>

    <script>
        // === 1. 核心数据库：引脚定义与重映射 ===
        const DB = {
            'TIM1': [
                {p:'PA8', c:1, r:null}, {p:'PA9', c:2, r:null}, {p:'PA10', c:3, r:null}, {p:'PA11', c:4, r:null},
                {p:'PE9', c:1, r:'GPIO_FullRemap_TIM1'}, {p:'PE11', c:2, r:'GPIO_FullRemap_TIM1'}, 
                {p:'PE13', c:3, r:'GPIO_FullRemap_TIM1'}, {p:'PE14', c:4, r:'GPIO_FullRemap_TIM1'}
            ],
            'TIM2': [
                {p:'PA0', c:1, r:null}, {p:'PA1', c:2, r:null}, {p:'PA2', c:3, r:null}, {p:'PA3', c:4, r:null},
                {p:'PA15', c:1, r:'GPIO_PartialRemap1_TIM2'}, {p:'PB3', c:2, r:'GPIO_PartialRemap1_TIM2'},
                {p:'PB10', c:3, r:'GPIO_PartialRemap2_TIM2'}, {p:'PB11', c:4, r:'GPIO_PartialRemap2_TIM2'}
            ],
            'TIM3': [
                {p:'PA6', c:1, r:null}, {p:'PA7', c:2, r:null}, {p:'PB0', c:3, r:null}, {p:'PB1', c:4, r:null},
                {p:'PB4', c:1, r:'GPIO_PartialRemap_TIM3'}, {p:'PB5', c:2, r:'GPIO_PartialRemap_TIM3'}, 
                {p:'PC6', c:1, r:'GPIO_FullRemap_TIM3'}, {p:'PC7', c:2, r:'GPIO_FullRemap_TIM3'},
                {p:'PC8', c:3, r:'GPIO_FullRemap_TIM3'}, {p:'PC9', c:4, r:'GPIO_FullRemap_TIM3'}
            ],
            'TIM4': [
                {p:'PB6', c:1, r:null}, {p:'PB7', c:2, r:null}, {p:'PB8', c:3, r:null}, {p:'PB9', c:4, r:null},
                {p:'PD12', c:1, r:'GPIO_Remap_TIM4'}, {p:'PD13', c:2, r:'GPIO_Remap_TIM4'},
                {p:'PD14', c:3, r:'GPIO_Remap_TIM4'}, {p:'PD15', c:4, r:'GPIO_Remap_TIM4'}
            ],
            'TIM8': [
                {p:'PC6', c:1, r:null}, {p:'PC7', c:2, r:null}, {p:'PC8', c:3, r:null}, {p:'PC9', c:4, r:null}
            ]
        };

        // === 2. 全局状态 ===
        const state = {
            tim: 'TIM3',
            pinIdx: 0,
            freq: 1000,
            duty: 50,
            sysClock: 72000000,
            polarity: 'High',
            funcName: 'Motor_PWM',
            currentTab: 'c'
        };

        // === 3. 初始化与事件监听 ===
        const el = id => document.getElementById(id);

        function init() {
            updatePinList();
            render();

            // 监听器绑定
            el('timer').onchange = e => { state.tim = e.target.value; updatePinList(); render(); };
            el('pin').onchange = e => { state.pinIdx = e.target.selectedIndex; render(); };
            
            const bindSync = (id, targetProp) => {
                el(id).oninput = e => {
                    let val = parseInt(e.target.value);
                    if(isNaN(val)) val = 0;
                    state[targetProp] = val;
                    if(id.includes('range')) el(id.replace('-range', '')).value = val;
                    else el(id + '-range').value = Math.min(val, parseInt(el(id+'-range').max));
                    
                    if(targetProp === 'freq') el('freq-disp').innerText = val + " Hz";
                    if(targetProp === 'duty') el('duty-disp').innerText = val + "%";
                    
                    render();
                }
            };

            bindSync('freq', 'freq'); bindSync('freq-range', 'freq');
            bindSync('duty', 'duty'); bindSync('duty-range', 'duty');

            el('toggle-adv').onclick = () => {
                const panel = el('adv-panel');
                panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
            };
            el('sys-clock').oninput = e => { state.sysClock = parseInt(e.target.value); render(); };
            el('polarity').onchange = e => { state.polarity = e.target.value; render(); };



            
            // 修复：当修改函数名时，触发重绘以更新标签页和下载文件名
            el('func-name').oninput = e => { 
                state.funcName = e.target.value || 'PWM'; 
                render(); 
            };
        }

        function updatePinList() {
            const list = DB[state.tim];
            el('pin').innerHTML = list.map((item, i) => {
                const remapText = item.r ? ' [重映射]' : '';
                return `<option value="${i}">${item.p} (通道 ${item.c})${remapText}</option>`;
            }).join('');
            state.pinIdx = 0;
        }

        // === 4. 核心算法 ===
        function calculate() {
            const f_sys = state.sysClock;
            let bestErr = Infinity;
            let bestPsc = 0, bestArr = 0;

            for(let p = 0; p < 65535; p++) {
                let targetArr = Math.round(f_sys / (state.freq * (p + 1))) - 1;
                if(targetArr < 99) continue;
                if(targetArr > 65535) break;

                let f_act = f_sys / ((p + 1) * (targetArr + 1));
                let err = Math.abs(f_act - state.freq);
                
                if(err < bestErr) {
                    bestErr = err; bestPsc = p; bestArr = targetArr;
                    if(err === 0) break;
                }
            }
            
            const ccr = Math.round((bestArr + 1) * (state.duty / 100));
            const f_real = f_sys / ((bestPsc + 1) * (bestArr + 1));
            const errPct = ((Math.abs(f_real - state.freq) / state.freq) * 100).toFixed(2);

            return { psc: bestPsc, arr: bestArr, ccr, f_real, err: errPct };
        }

        // === 5. 代码生成 (C) ===
        function generateC(calc, cfg) {
            const k = t => `<span class="c-kw">${t}</span>`;
            const f = t => `<span class="c-fn">${t}</span>`;
            const d = t => `<span class="c-df">${t}</span>`;
            const c = t => `<span class="c-cm">${t}</span>`;
            const n = t => `<span class="c-nm">${t}</span>`;
            const ty = t => `<span class="c-ty">${t}</span>`;

            const isAdv = (state.tim === 'TIM1' || state.tim === 'TIM8');
            const busCmd = isAdv ? 'RCC_APB2PeriphClockCmd' : 'RCC_APB1PeriphClockCmd';
            const busDef = isAdv ? `RCC_APB2Periph_${state.tim}` : `RCC_APB1Periph_${state.tim}`;
            const pinName = cfg.p;
            const port = 'GPIO' + pinName.charAt(1);
            const pinNum = 'GPIO_Pin_' + pinName.substring(2);
            const prefix = state.funcName;

            let code = c(`// STM32 PWM配置 | 定时器: ${state.tim} 通道: ${cfg.c} 引脚: ${pinName}`) + '\n';
            code += c(`// 目标频率: ${state.freq}Hz | 实际频率: ${calc.f_real.toFixed(1)}Hz | 误差: ${calc.err}%`) + '\n';
            code += `#include "stm32f10x.h"\n`;
            code += `#include "${prefix.toLowerCase()}.h"\n\n`; // 包含对应的头文件
            
            code += `${k('void')} ${f(prefix + '_Init')}(${k('void')}) {\n`;
            
            code += `    ${c('// 1. 开启时钟')}\n`;
            code += `    ${f(busCmd)}(${d(busDef)}, ${d('ENABLE')});\n`;
            code += `    ${f('RCC_APB2PeriphClockCmd')}(${d('RCC_APB2Periph_' + port)}, ${d('ENABLE')});\n`;
            
            if(cfg.r) {
                code += `    ${c('// 开启AFIO时钟并配置重映射')}\n`;
                code += `    ${f('RCC_APB2PeriphClockCmd')}(${d('RCC_APB2Periph_AFIO')}, ${d('ENABLE')});\n`;
                code += `    ${f('GPIO_PinRemapConfig')}(${d(cfg.r)}, ${d('ENABLE')});\n`;
            }

            code += `\n    ${c('// 2. GPIO 初始化')}\n`;
            code += `    ${ty('GPIO_InitTypeDef')} GPIO_InitStructure;\n`;
            code += `    GPIO_InitStructure.GPIO_Pin = ${d(pinNum)};\n`;
            code += `    GPIO_InitStructure.GPIO_Mode = ${d('GPIO_Mode_AF_PP')};\n`;
            code += `    GPIO_InitStructure.GPIO_Speed = ${d('GPIO_Speed_50MHz')};\n`;
            code += `    ${f('GPIO_Init')}(${d(port)}, &GPIO_InitStructure);\n`;

            code += `\n    ${c('// 3. 定时器时基配置')}\n`;
            code += `    ${ty('TIM_TimeBaseInitTypeDef')} TIM_TimeBaseStructure;\n`;
            code += `    TIM_TimeBaseStructure.TIM_Period = ${n(calc.arr)};\n`;
            code += `    TIM_TimeBaseStructure.TIM_Prescaler = ${n(calc.psc)};\n`;
            code += `    TIM_TimeBaseStructure.TIM_ClockDivision = 0;\n`;
            code += `    TIM_TimeBaseStructure.TIM_CounterMode = ${d('TIM_CounterMode_Up')};\n`;
            code += `    ${f('TIM_TimeBaseInit')}(${d(state.tim)}, &TIM_TimeBaseStructure);\n`;

            code += `\n    ${c('// 4. PWM 通道配置')}\n`;
            code += `    ${ty('TIM_OCInitTypeDef')} TIM_OCInitStructure;\n`;
            code += `    ${f('TIM_OCStructInit')}(&TIM_OCInitStructure);\n`;
            code += `    TIM_OCInitStructure.TIM_OCMode = ${d('TIM_OCMode_PWM1')};\n`;
            code += `    TIM_OCInitStructure.TIM_OutputState = ${d('TIM_OutputState_Enable')};\n`;
            code += `    TIM_OCInitStructure.TIM_Pulse = ${n(calc.ccr)};\n`;
            code += `    TIM_OCInitStructure.TIM_OCPolarity = ${d('TIM_OCPolarity_' + state.polarity)};\n`;
            
            if(isAdv) {
                 code += `    TIM_OCInitStructure.TIM_OutputNState = ${d('TIM_OutputNState_Disable')};\n`;
                 code += `    TIM_OCInitStructure.TIM_OCIdleState = ${d('TIM_OCIdleState_Set')};\n`;
            }

            code += `    ${f('TIM_OC' + cfg.c + 'Init')}(${d(state.tim)}, &TIM_OCInitStructure);\n`;
            code += `    ${f('TIM_OC' + cfg.c + 'PreloadConfig')}(${d(state.tim)}, ${d('TIM_OCPreload_Enable')});\n`;

            code += `\n    ${c('// 5. 使能定时器')}\n`;
            code += `    ${f('TIM_Cmd')}(${d(state.tim)}, ${d('ENABLE')});\n`;
            if(isAdv) code += `    ${f('TIM_CtrlPWMOutputs')}(${d(state.tim)}, ${d('ENABLE')});\n`;
            
            code += `}\n\n`;
            code += `${k('void')} ${f(prefix + '_SetDuty')}(${ty('uint16_t')} duty) {\n`;
            code += `    ${k('if')}(duty > 100) duty = 100;\n`;
            code += `    ${ty('uint16_t')} ccr = (${d(state.tim)}->ARR + 1) * duty / 100;\n`;
            code += `    ${d(state.tim)}->CCR${cfg.c} = ccr;\n`;
            code += `}`;
            
            return code;
        }

        // === 6. 代码生成 (H) ===
        function generateH() {
            const prefix = state.funcName;
            const c = t => `<span class="c-cm">${t}</span>`;
            const upper = prefix.toUpperCase();
            
            return `${c('#ifndef __' + upper + '_H')}\n${c('#define __' + upper + '_H')}\n\n` +
                   `#include "stm32f10x.h"\n\n` +
                   `void ${prefix}_Init(void);\n` +
                   `void ${prefix}_SetDuty(uint16_t duty);\n\n` +
                   `${c('#endif')}`;
        }

        // === 7. 渲染 ===
        function render() {
            const cfg = DB[state.tim][state.pinIdx];
            const calc = calculate();
            
            // UI 更新
            el('channel-disp').innerText = `${state.tim} 通道 ${cfg.c}`;
            
            const badge = el('pin-badge');
            if(cfg.r) {
                badge.className = 'badge badge-remap';
                badge.innerText = '重映射';
            } else {
                badge.className = 'badge badge-def';
                badge.innerText = '默认引脚';
            }
            
            el('res-arr').innerText = calc.arr;
            el('res-psc').innerText = calc.psc;
            el('res-freq').innerText = calc.f_real.toFixed(1) + ' Hz';
            
            const errElem = el('res-err');
            errElem.innerText = calc.err + '%';
            errElem.className = parseFloat(calc.err) > 1.0 ? 'stat-value error' : 'stat-value';

            // 修复：更新标签页标题
            const baseName = state.funcName.toLowerCase() || 'pwm';
            el('tab-c').innerText = `${baseName}.c`;
            el('tab-h').innerText = `${baseName}.h`;

            // 代码更新
            if(state.currentTab === 'c') {
                el('code-inner').innerHTML = generateC(calc, cfg);
            } else {
                el('code-inner').innerHTML = generateH();
            }
        }

        function switchTab(t) {
            state.currentTab = t;
            document.querySelectorAll('.tab').forEach(e => e.classList.remove('active'));
            document.getElementById(`tab-${t}`).classList.add('active');
            render();
        }

        function copyCode() {
            navigator.clipboard.writeText(el('code-inner').innerText);
            showToast('代码已复制到剪贴板');
        }

        function showToast(msg) {
            const t = el('toast');
            el('toast-msg').innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        }

        function downloadFiles() {
            const content = el('code-inner').innerText;
            const blob = new Blob([content], {type: "text/plain;charset=utf-8"});
            const link = document.createElement("a");
            
            // 修复：使用动态文件名
            const baseName = state.funcName.toLowerCase() || 'pwm';
            const fileName = state.currentTab === 'c' ? `${baseName}.c` : `${baseName}.h`;
            
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            link.click();
            
            showToast(`已下载 ${fileName}`);
        }

        init();
    </script>
</body>
</html>
